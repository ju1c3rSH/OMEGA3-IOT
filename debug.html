<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMEGA3-IOT API 控制台</title>
    <!-- 引入 Roboto 字体 和 Material Symbols 图标 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    
    <style>
        /* --- Material Design 3 Design Tokens (Simplified) --- */
        :root {
            --md-sys-color-primary: #0061a4;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d1e4ff;
            --md-sys-color-on-primary-container: #001d36;
            
            --md-sys-color-secondary: #535f70;
            --md-sys-color-on-secondary: #ffffff;
            
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;
            
            --md-sys-color-background: #fdfcff;
            --md-sys-color-on-background: #1a1c1e;
            
            --md-sys-color-surface: #fdfcff;
            --md-sys-color-surface-container-low: #f3f5fbb0;
            --md-sys-color-surface-container: #eceef4;
            --md-sys-color-surface-container-high: #e7e8ee;
            
            --md-sys-color-on-surface: #1a1c1e;
            --md-sys-color-on-surface-variant: #43474e;
            --md-sys-color-outline: #73777f;
            --md-sys-color-outline-variant: #c3c7cf;

            --md-sys-shape-corner-small: 8px;
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-full: 9999px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            line-height: 1.5;
            padding: 24px;
            display: flex;
            justify-content: center;
        }

        .app-container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 24px; }

        .header { text-align: center; margin-bottom: 16px; padding: 20px 0; }
        .header h1 { font-size: 2.25rem; font-weight: 400; color: var(--md-sys-color-on-surface); display: flex; align-items: center; justify-content: center; gap: 12px; }
        .header-icon { font-size: 2.5rem; color: var(--md-sys-color-primary); }
        .header p { font-size: 1rem; color: var(--md-sys-color-on-surface-variant); margin-top: 8px; }

        /* Cards */
        .md-card {
            background-color: var(--md-sys-color-surface);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 24px;
            border: 1px solid var(--md-sys-color-outline-variant);
            transition: all 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
        }
        .md-card:hover { background-color: #f8f9fa; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
        .card-title { display: flex; align-items: center; gap: 12px; }
        .card-title h2 { font-size: 1.375rem; font-weight: 500; color: var(--md-sys-color-on-surface); margin: 0; }
        .card-icon { color: var(--md-sys-color-primary); font-size: 24px; }
        .api-badge { background-color: var(--md-sys-color-surface-container-high); color: var(--md-sys-color-on-surface-variant); padding: 4px 12px; border-radius: 8px; font-family: 'Roboto Mono', monospace; font-size: 0.75rem; font-weight: 500; }

        /* Inputs */
        .input-group { position: relative; margin-bottom: 24px; }
        .md-input {
            width: 100%; height: 56px; padding: 0 16px; font-size: 1rem; color: var(--md-sys-color-on-surface);
            background: transparent; border: 1px solid var(--md-sys-color-outline); border-radius: 4px; outline: none;
            transition: border-color 0.2s, box-shadow 0.2s; appearance: none;
        }
        .md-input:focus { border-color: var(--md-sys-color-primary); border-width: 2px; padding: 0 15px; }
        .md-input-label { position: absolute; left: 12px; top: -10px; background-color: var(--md-sys-color-surface); padding: 0 4px; font-size: 0.75rem; color: var(--md-sys-color-primary); font-weight: 500; pointer-events: none; }
        .form-label { display: block; margin-bottom: 8px; font-size: 0.875rem; font-weight: 500; color: var(--md-sys-color-on-surface-variant); }

        /* Buttons */
        .md-btn {
            display: inline-flex; align-items: center; justify-content: center; height: 40px; padding: 0 24px;
            border-radius: var(--md-sys-shape-corner-full); border: none; font-family: 'Roboto', sans-serif;
            font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; gap: 8px; width: 100%;
        }
        .md-btn-primary { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .md-btn-primary:hover:not(:disabled) { opacity: 0.92; box-shadow: 0 1px 3px 1px rgba(0, 0, 0, 0.15); }
        .md-btn:disabled { background-color: rgba(28, 27, 31, 0.12); color: rgba(28, 27, 31, 0.38); cursor: not-allowed; }

        /* Status & Result */
        .data-display-box { background-color: var(--md-sys-color-surface-container); border-radius: 8px; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; margin-top: 8px; border: 1px dashed var(--md-sys-color-outline-variant); }
        .data-value { font-family: 'Roboto Mono', monospace; font-size: 0.85rem; word-break: break-all; margin-right: 12px; }
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--md-sys-color-on-surface-variant); padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background-color: rgba(28, 27, 31, 0.08); color: var(--md-sys-color-primary); }
        
        .status-chip { display: inline-flex; align-items: center; padding: 6px 16px; border-radius: 8px; font-size: 0.875rem; font-weight: 500; gap: 8px; }
        .status-chip.offline { background-color: var(--md-sys-color-error-container); color: var(--md-sys-color-error); }
        .status-chip.online { background-color: #c4eed0; color: #0d652d; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; }

        .result-card { background-color: #1e1e1e; color: #e0e0e0; border-radius: var(--md-sys-shape-corner-medium); overflow: hidden; }
        .result-header { background-color: #2d2d2d; padding: 12px 20px; font-size: 0.875rem; color: #a0a0a0; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #333; }
        .result-content { padding: 0; max-height: 500px; overflow-y: auto; }
        
        /* Prism overrides */
        pre[class*="language-"] { margin: 0 !important; border-radius: 0 !important; background: transparent !important; text-shadow: none !important; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #bdbdbd; border-radius: 4px; }
        .helper-text { font-size: 0.75rem; color: var(--md-sys-color-on-surface-variant); margin-bottom: 16px; margin-top: -4px; }
    </style>
</head>
<body>

<div class="app-container">
    
    <!-- Header -->
    <header class="header">
        <h1>
            <span class="material-symbols-outlined header-icon">hub</span>
            OMEGA3-IOT
        </h1>
        <p>API 调试与设备管理控制台</p>
    </header>

    <!-- Config Card -->
    <div class="md-card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-symbols-outlined card-icon">settings</span>
                <h2>环境配置</h2>
            </div>
        </div>
        <div class="input-group">
            <label class="form-label" for="base_url">API 基础地址 (Base URL)</label>
            <input type="text" class="md-input" id="base_url" value="http://localhost:27015/api/v1" placeholder="例如: http://localhost:1234/api/v1">
        </div>
    </div>

    <!-- 1. Register Card -->
    <div class="md-card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-symbols-outlined card-icon">person_add</span>
                <h2>1. 用户注册</h2>
            </div>
            <span class="api-badge">POST /users/register</span>
        </div>
        
        <div class="input-group">
            <label class="md-input-label">用户名</label>
            <input type="text" class="md-input" id="reg_username" placeholder=" ">
        </div>
        <div class="input-group">
            <label class="md-input-label">密码</label>
            <input type="password" class="md-input" id="reg_password" placeholder=" ">
        </div>
        
        <button class="md-btn md-btn-primary" onclick="registerUser()">
            <span class="material-symbols-outlined">how_to_reg</span>
            注册新用户
        </button>
    </div>

    <!-- 2. Login Card -->
    <div class="md-card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-symbols-outlined card-icon">login</span>
                <h2>2. 用户登录</h2>
            </div>
            <span class="api-badge">POST /users/login</span>
        </div>

        <div class="input-group">
            <label class="md-input-label">用户名</label>
            <input type="text" class="md-input" id="login_username" placeholder=" ">
        </div>
        <div class="input-group">
            <label class="md-input-label">密码</label>
            <input type="password" class="md-input" id="login_password" placeholder=" ">
        </div>

        <button class="md-btn md-btn-primary" onclick="loginUser()">
            <span class="material-symbols-outlined">key</span>
            登录获取 Token
        </button>
        
        <div style="margin-top: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label class="form-label" style="margin:0">鉴权状态</label>
                <div id="login-status" class="status-chip offline">
                    <div class="status-dot"></div> 未登录
                </div>
            </div>
            
            <div class="data-display-box">
                <span id="token_display" class="data-value" style="opacity: 0.6;">未获取 Token</span>
                <button class="icon-btn" onclick="copyToken()" title="复制 Token">
                    <span class="material-symbols-outlined">content_copy</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 3. Device Anon Register -->
    <div class="md-card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-symbols-outlined card-icon">devices_other</span>
                <h2>3. 匿名设备注册</h2>
            </div>
            <span class="api-badge">POST /device/deviceRegisterAnon</span>
        </div>
        
        <p class="helper-text">模拟设备开机后的自动注册流程，无需用户登录。</p>

        <div class="input-group">
            <label class="form-label" for="device_type_id">设备类型</label>
            <select id="device_type_id" class="md-input">
                <option value="1">1 - 基础测试用定位器</option>
                <option value="2">2 - 智能传感器</option>
            </select>
        </div>

        <button class="md-btn md-btn-primary" onclick="registerDeviceAnonymously()">
            <span class="material-symbols-outlined">rss_feed</span>
            模拟设备注册
        </button>
        
        <div style="margin-top: 24px;">
            <label class="form-label">获取的设备注册码 (RegCode)</label>
            <div class="data-display-box">
                <span id="reg_code_display" class="data-value" style="font-size: 1.1rem; font-weight: bold; opacity: 0.6;">-</span>
                <button class="icon-btn" onclick="copyRegCode()" title="复制 RegCode">
                    <span class="material-symbols-outlined">content_copy</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 4. Bind Device -->
    <div class="md-card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-symbols-outlined card-icon">link</span>
                <h2>4. 绑定设备到用户</h2>
            </div>
            <span class="api-badge">POST /users/bindDeviceByRegCode</span>
        </div>
        
        <p class="helper-text">需要先登录。将上一步生成的 RegCode 绑定到当前账户。</p>

        <div class="input-group">
            <label class="md-input-label">Reg Code</label>
            <input type="text" id="bind_reg_code" class="md-input" placeholder=" ">
        </div>
        <div class="input-group">
            <label class="md-input-label">设备昵称 (可选)</label>
            <input type="text" id="bind_device_nick" class="md-input" placeholder=" ">
        </div>
        <div class="input-group">
            <label class="md-input-label">设备备注 (可选)</label>
            <input type="text" id="bind_device_remark" class="md-input" placeholder=" ">
        </div>

        <button id="bind-device-btn" class="md-btn md-btn-primary" onclick="bindDeviceByRegCode()" disabled>
            <span class="material-symbols-outlined">add_link</span>
            绑定设备
        </button>
    </div>

    <!-- 5. Get User Devices (New!) -->
    <div class="md-card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-symbols-outlined card-icon">view_list</span>
                <h2>5. 获取用户设备列表</h2>
            </div>
            <span class="api-badge">GET /users/getUserAllDevices</span>
        </div>
        
        <p class="helper-text">需要先登录。获取当前用户绑定的所有设备信息。</p>

        <button id="get-devices-btn" class="md-btn md-btn-primary" onclick="getUserDevices()" disabled>
            <span class="material-symbols-outlined">format_list_bulleted</span>
            获取设备列表
        </button>
    </div>

    <!-- Result Console -->
    <div class="result-card">
        <div class="result-header">
            <span class="material-symbols-outlined" style="font-size: 16px;">terminal</span>
            调试终端输出
        </div>
        <div class="result-content">
            <pre><code id="result" class="language-json">等待操作...</code></pre>
        </div>
    </div>

</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script>
    const BASE_URL_INPUT = document.getElementById('base_url');
    let BASE_URL = BASE_URL_INPUT.value;
    let token = "";
    let regCode = "";

    BASE_URL_INPUT.addEventListener('input', function() {
        BASE_URL = this.value;
    });

    function updateAuthState() {
        const bindBtn = document.getElementById('bind-device-btn');
        const getDevicesBtn = document.getElementById('get-devices-btn'); // 获取按钮引用
        const loginStatus = document.getElementById('login-status');
        const tokenDisplay = document.getElementById('token_display');
        
        if (token) {
            bindBtn.disabled = false;
            getDevicesBtn.disabled = false; // 登录后启用
            loginStatus.innerHTML = '<div class="status-dot"></div> 已登录';
            loginStatus.className = 'status-chip online';
            tokenDisplay.style.opacity = '1';
        } else {
            bindBtn.disabled = true;
            getDevicesBtn.disabled = true; // 未登录禁用
            loginStatus.innerHTML = '<div class="status-dot"></div> 未登录';
            loginStatus.className = 'status-chip offline';
            tokenDisplay.style.opacity = '0.6';
        }
    }

    function setOutput(data) {
        const resultEl = document.getElementById("result");
        if (typeof data === 'object') {
            resultEl.textContent = JSON.stringify(data, null, 2);
        } else {
            resultEl.textContent = data;
        }
        Prism.highlightElement(resultEl);
        resultEl.parentNode.scrollTop = resultEl.parentNode.scrollHeight;
    }

    function setLoading(isLoading, btnText, elementId) {
        const btn = document.querySelector(`button[onclick="${elementId}"]`);
        if (btn) {
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = `<span class="material-symbols-outlined" style="animation: spin 1s linear infinite; font-size: 18px;">progress_activity</span> 处理中...`;
            } else {
                btn.disabled = false;
                
                // Icon mapping
                let icon = '';
                if(elementId.includes('registerUser')) icon = 'how_to_reg';
                else if(elementId.includes('loginUser')) icon = 'key';
                else if(elementId.includes('registerDevice')) icon = 'rss_feed';
                else if(elementId.includes('bindDevice')) icon = 'add_link';
                else if(elementId.includes('getUserDevices')) icon = 'format_list_bulleted'; // 新图标
                
                btn.innerHTML = `<span class="material-symbols-outlined">${icon}</span> ${btnText}`;
            }
        }
    }

    const styleSheet = document.createElement("style");
    styleSheet.innerText = `@keyframes spin { 100% { transform: rotate(360deg); } }`;
    document.head.appendChild(styleSheet);

    async function apiRequest(url, method, body = null, useAuth = false) {
        const headers = { "Content-Type": "application/json" };
        if (useAuth && token) {
            headers["Authorization"] = "Bearer " + token;
        }

        const config = { method, headers };
        if (body) config.body = JSON.stringify(body);

        try {
            const response = await fetch(BASE_URL + url, config);
            let data;
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                data = await response.json();
            } else {
                data = await response.text();
            }
            return { ok: response.ok, status: response.status, data };
        } catch (err) {
            return { ok: false, status: 0, data: { error: "网络请求失败: " + err.message } };
        }
    }

    // --- Actions ---
    async function registerUser() {
        setLoading(true, "注册新用户", "registerUser()");
        const username = document.getElementById("reg_username").value;
        const password = document.getElementById("reg_password").value;
        if (!username || !password) {
            alert("请填写用户名和密码");
            setLoading(false, "注册新用户", "registerUser()");
            return;
        }
        const res = await apiRequest("/users/register", "POST", { username, password });
        setOutput(res.data);
        setLoading(false, "注册新用户", "registerUser()");
    }

    async function loginUser() {
        setLoading(true, "登录获取 Token", "loginUser()");
        const username = document.getElementById("login_username").value;
        const password = document.getElementById("login_password").value;
        if (!username || !password) {
            alert("请填写用户名和密码");
            setLoading(false, "登录获取 Token", "loginUser()");
            return;
        }
        const res = await apiRequest("/users/login", "POST", { username, password });
        if (res.ok) {
            token = res.data.access_token;
            document.getElementById("token_display").textContent = token;
            updateAuthState();
        }
        setOutput(res.data);
        setLoading(false, "登录获取 Token", "loginUser()");
    }

    async function registerDeviceAnonymously() {
        setLoading(true, "模拟设备注册", "registerDeviceAnonymously()");
        const deviceTypeId = parseInt(document.getElementById("device_type_id").value);
        const res = await apiRequest(`/device/deviceRegisterAnon?device_type_id=${deviceTypeId}`, "POST");
        if (res.ok) {
            if(res.data.device && res.data.device.reg_code) {
                regCode = res.data.device.reg_code;
                document.getElementById("reg_code_display").textContent = regCode;
                document.getElementById("bind_reg_code").value = regCode;
                document.getElementById("reg_code_display").style.opacity = '1';
            }
        }
        setOutput(res.data);
        setLoading(false, "模拟设备注册", "registerDeviceAnonymously()");
    }

    async function bindDeviceByRegCode() {
        if (!token) {
            alert("请先登录！");
            return;
        }
        setLoading(true, "绑定设备", "bindDeviceByRegCode()");
        const regCodeInput = document.getElementById("bind_reg_code").value;
        const deviceNick = document.getElementById("bind_device_nick").value || "";
        const deviceRemark = document.getElementById("bind_device_remark").value || "";

        if (!regCodeInput) {
            alert("请输入 Reg Code");
            setLoading(false, "绑定设备", "bindDeviceByRegCode()");
            return;
        }

        const res = await apiRequest("/users/bindDeviceByRegCode", "POST", {
            reg_code: regCodeInput,
            device_nick: deviceNick,
            device_remark: deviceRemark
        }, true);

        setOutput(res.data);
        setLoading(false, "绑定设备", "bindDeviceByRegCode()");
    }

    // --- New Function: Get User Devices ---
    async function getUserDevices() {
        if (!token) {
            alert("请先登录！");
            return;
        }
        setLoading(true, "获取设备列表", "getUserDevices()");
        
        // 注意：根据之前的路由，路径可能是 /users/getUserAllDevices
        // 如果后端有变化（例如 /api/v1/user/all-devices），请修改这里
        const res = await apiRequest("/users/getUserAllDevices", "GET", null, true);

        setOutput(res.data);
        setLoading(false, "获取设备列表", "getUserDevices()");
    }

    function copyToken() {
        const text = document.getElementById("token_display").textContent;
        if (text && text !== "未获取 Token") {
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('button[title="复制 Token"] span');
                const original = btn.innerText;
                btn.innerText = 'check';
                setTimeout(()=> btn.innerText = original, 1500);
            });
        }
    }

    function copyRegCode() {
        const text = document.getElementById("reg_code_display").textContent;
        if (text && text !== "-") {
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('button[title="复制 RegCode"] span');
                const original = btn.innerText;
                btn.innerText = 'check';
                setTimeout(()=> btn.innerText = original, 1500);
            });
        }
    }

    updateAuthState();
</script>

</body>
</html>