<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMEGA3-IOT 全功能调试台</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" rel="stylesheet" />
    <style>
        :root {
            --primary: #0061a4; --primary-bg: #d1e4ff;
            --secondary: #535f70; --bg: #f2f4f8;
            --surface: #ffffff; --border: #e0e2e8;
            --success: #1b5e20; --success-bg: #c8e6c9;
            --post-badge: #d1e4ff; --post-text: #004b8a;
            --get-badge: #c8e6c9; --get-text: #0a4e23;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        body { background: var(--bg); color: #1f1f1f; padding: 20px; height: 100vh; display: flex; flex-direction: column; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px; }
        h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        .config-bar { display: flex; gap: 10px; width: 400px; }
        
        /* Layout */
        .main-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 16px; 
            flex: 1; 
            overflow-y: auto; 
            padding-bottom: 200px; /* Space for console */
        }
        @media(max-width: 1100px) { .main-grid { grid-template-columns: 1fr 1fr; } }
        @media(max-width: 700px) { .main-grid { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); display: flex; flex-direction: column; }
        .card-header { padding: 12px 16px; background: #f8f9fa; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; align-items: center; gap: 8px; color: #444; }
        .card-body { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        
        /* Elements */
        .api-row { border-bottom: 1px dashed #eee; padding-bottom: 12px; margin-bottom: 12px; }
        .api-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-right: 6px; font-family: monospace; }
        .post { background: var(--post-badge); color: var(--post-text); }
        .get { background: var(--get-badge); color: var(--get-text); }
        
        label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 4px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem; transition: 0.2s; }
        input:focus { border-color: var(--primary); outline: none; }
        
        button { width: 100%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
        button:hover:not(:disabled) { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.secondary { background: var(--secondary); }
        
        .status-pill { font-size: 0.75rem; padding: 4px 8px; border-radius: 12px; background: #eee; color: #666; display: inline-flex; align-items: center; gap: 4px; }
        .status-pill.active { background: var(--success-bg); color: var(--success); }

        /* Console */
        .console-drawer {
            position: fixed; bottom: 0; left: 0; right: 0; height: 180px;
            background: #1e1e1e; color: #e0e0e0; border-top: 2px solid #333;
            display: flex; flex-direction: column; z-index: 100;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        }
        .console-header { padding: 5px 15px; background: #2d2d2d; font-size: 0.8rem; display: flex; justify-content: space-between; }
        .console-body { flex: 1; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; }
        .log-entry { margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .log-err { color: #ef5350; } .log-ok { color: #9ccc65; }
    </style>
</head>
<body>

<header>
    <h1><span class="material-symbols-outlined">hub</span> OMEGA3-IOT <span style="font-size:0.9rem; opacity:0.6; margin-left:10px">v1.2 Debugger</span></h1>
    <div class="config-bar">
        <input type="text" id="base_url" value="http://localhost:27015/api/v1" placeholder="API Base URL">
        <div id="auth_indicator" class="status-pill">● 未登录</div>
    </div>
</header>

<div class="main-grid">

    <!-- Column 1: Auth & User -->
    <div style="display:flex; flex-direction:column; gap:16px">
        <!-- System Health -->
        <div class="card">
            <div class="card-header"><span class="material-symbols-outlined">dns</span> 系统检测</div>
            <div class="card-body">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <button class="secondary" onclick="req('/health','GET')"><span class="badge get">GET</span> Health</button>
                    <button class="secondary" onclick="req('/test?msg=ping','GET')"><span class="badge get">GET</span> Test</button>
                </div>
            </div>
        </div>

        <!-- Auth -->
        <div class="card">
            <div class="card-header"><span class="material-symbols-outlined">badge</span> 认证 (Auth)</div>
            <div class="card-body">
                <div class="api-row">
                    <label>用户名 / 密码</label>
                    <div style="display:flex; gap:8px; margin-bottom:8px">
                        <input type="text" id="username" value="admin" placeholder="User">
                        <input type="password" id="password" value="123456" placeholder="Pass">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                        <button onclick="register()"><span class="badge post">POST</span> 注册</button>
                        <button onclick="login()"><span class="badge post">POST</span> 登录</button>
                    </div>
                </div>
                <div class="api-row">
                    <label>Token (自动填充)</label>
                    <input type="text" id="token_display" disabled style="background:#f5f5f5; color:#888; font-size:0.8rem">
                </div>
                <div>
                    <button onclick="req('/users/info','GET', null, true)"><span class="badge get">GET</span> 获取用户信息 (Info)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column 2: Device Management -->
    <div style="display:flex; flex-direction:column; gap:16px">
        <!-- Add Device -->
        <div class="card">
            <div class="card-header"><span class="material-symbols-outlined">add_circle</span> 设备注册 (创建)</div>
            <div class="card-body">
                <!-- User Add Device -->
                <div class="api-row">
                    <span class="badge post">POST</span> /users/addDevice
                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:8px; margin:8px 0">
                        <input type="text" id="dev_name" value="SmartLight-01" placeholder="设备名">
                        <input type="number" id="dev_type" value="1" placeholder="类型ID">
                    </div>
                    <input type="text" id="dev_desc" placeholder="描述 (可选)" style="margin-bottom:8px">
                    <button onclick="addDevice()">添加设备 (用户)</button>
                </div>
                
                <!-- Anon Register -->
                <div class="api-row">
                    <span class="badge post">POST</span> /device/deviceRegisterAnon
                    <label style="margin-top:8px">无需 Token，返回 RegCode</label>
                    <div style="display:flex; gap:8px; margin-top:4px">
                        <input type="number" id="anon_type" value="1" style="width:80px" placeholder="Type">
                        <button class="secondary" onclick="regAnon()">匿名注册</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bind Device -->
        <div class="card">
            <div class="card-header"><span class="material-symbols-outlined">link</span> 设备绑定</div>
            <div class="card-body">
                <div class="api-row">
                    <span class="badge post">POST</span> /users/bindDeviceByRegCode
                    <label style="margin-top:8px">Reg Code (自动填充)</label>
                    <input type="text" id="bind_code" placeholder="从匿名注册获取...">
                    <button onclick="bindDevice()" style="margin-top:8px">绑定设备</button>
                </div>
                <div>
                    <button class="secondary" onclick="req('/users/getUserAllDevices','GET', null, true)">
                        <span class="badge get">GET</span> 获取我的所有设备
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column 3: Control & Share -->
    <div style="display:flex; flex-direction:column; gap:16px">
        
        <!-- Context Config -->
        <div class="card" style="border-color:var(--primary)">
            <div class="card-header" style="color:var(--primary); background:#e3f2fd">
                <span class="material-symbols-outlined">settings_remote</span> 操作上下文
            </div>
            <div class="card-body">
                <label>目标设备 Instance UUID (下方操作使用)</label>
                <input type="text" id="target_uuid" placeholder="添加/注册后自动填入...">
            </div>
        </div>

        <!-- Actions -->
        <div class="card">
            <div class="card-header"><span class="material-symbols-outlined">bolt</span> 设备控制 (MQTT)</div>
            <div class="card-body">
                <div class="api-row">
                    <span class="badge post">POST</span> /devices/:uuid/actions
                    <div style="margin:8px 0">
                        <input type="text" id="mqtt_cmd" value="toggle" placeholder="Command">
                    </div>
                    <textarea id="mqtt_params" style="height:50px; font-family:monospace" placeholder='{"speed": 100}'>{}</textarea>
                    <button onclick="sendAction()" style="margin-top:8px">发送指令</button>
                </div>
            </div>
        </div>

        <!-- Share & Access -->
        <div class="card">
            <div class="card-header"><span class="material-symbols-outlined">share</span> 共享与权限</div>
            <div class="card-body">
                <div class="api-row">
                    <span class="badge post">POST</span> /devices/:uuid/share
                    <input type="text" id="share_to_uuid" placeholder="对方 User UUID" style="margin:8px 0">
                    <div style="display:flex; gap:8px; margin-bottom:8px">
                        <select id="share_perm">
                            <option value="read">Read</option>
                            <option value="write">Write</option>
                            <option value="read_write">Read/Write</option>
                        </select>
                        <input type="number" id="share_exp" value="86400" placeholder="秒">
                    </div>
                    <button onclick="shareDevice()">分享设备</button>
                </div>
                <div>
                    <button class="secondary" onclick="req('/devices/accessible','GET', null, true)">
                        <span class="badge get">GET</span> 获取可访问设备 (Accessible)
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="console-drawer">
    <div class="console-header">
        <span>调试日志 (JSON Response)</span>
        <span style="cursor:pointer" onclick="document.getElementById('console_out').innerHTML=''">清除</span>
    </div>
    <div class="console-body" id="console_out">
        <div style="color:#666">// 等待操作...</div>
    </div>
</div>

<script>
    // --- Global State ---
    const state = {
        token: localStorage.getItem('iot_token') || "",
        lastDeviceUUID: "",
        lastRegCode: ""
    };

    // --- Init ---
    if(state.token) {
        document.getElementById('token_display').value = state.token.substring(0,20) + "...";
        updateAuthUI(true);
    }

    // --- Core API Request Function ---
    async function req(path, method, body = null, useAuth = false) {
        const baseUrl = document.getElementById('base_url').value.replace(/\/$/, "");
        const url = baseUrl + path;
        
        const headers = { "Content-Type": "application/json" };
        if (useAuth && state.token) {
            headers["Authorization"] = "Bearer " + state.token;
        }

        log(`> ${method} ${path}`, 'cmd');

        try {
            const res = await fetch(url, {
                method: method,
                headers: headers,
                body: body ? JSON.stringify(body) : null
            });

            // Handle content type
            const contentType = res.headers.get("content-type");
            let data;
            if (contentType && contentType.indexOf("application/json") !== -1) {
                data = await res.json();
            } else {
                data = await res.text();
            }

            if (!res.ok) throw data;
            
            log(data, 'ok');
            return data;
        } catch (err) {
            log(err, 'err');
            throw err;
        }
    }

    // --- Auth Actions ---
    function updateAuthUI(isLoggedIn) {
        const el = document.getElementById('auth_indicator');
        if(isLoggedIn) {
            el.className = "status-pill active";
            el.innerText = "● 已登录";
        } else {
            el.className = "status-pill";
            el.innerText = "● 未登录";
        }
    }

    async function login() {
        try {
            const res = await req('/users/login', 'POST', {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            });
            // Adapt to your response structure (e.g., res.access_token or res.data.token)
            const token = res.access_token || res.token || (res.data && res.data.token);
            if (token) {
                state.token = token;
                localStorage.setItem('iot_token', token);
                document.getElementById('token_display').value = token.substring(0,20) + "...";
                updateAuthUI(true);
            }
        } catch(e) {}
    }

    async function register() {
        await req('/users/register', 'POST', {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value
        });
    }

    // --- Device Actions ---
    async function addDevice() {
        try {
            const res = await req('/users/addDevice', 'POST', {
                name: document.getElementById('dev_name').value,
                device_type: parseInt(document.getElementById('dev_type').value),
                description: document.getElementById('dev_desc').value
            }, true);
            
            // Auto-fill UUID logic
            // Assuming response like { data: { uuid: "..." } } or { device: { uuid: "..." } }
            const dev = res.data || res.device || res;
            const uuid = dev.uuid || dev.InstanceUUID || dev.id;
            if(uuid) {
                state.lastDeviceUUID = uuid;
                document.getElementById('target_uuid').value = uuid;
                log(`[Sys] Auto-filled UUID: ${uuid}`, 'cmd');
            }
        } catch(e){}
    }

    async function regAnon() {
        try {
            const res = await req('/device/deviceRegisterAnon', 'POST', {
                device_type_id: parseInt(document.getElementById('anon_type').value)
            });
            
            // Structure: res.data.device.reg_code / uuid
            const d = res.data?.device || res.device;
            if(d) {
                if(d.reg_code) {
                    document.getElementById('bind_code').value = d.reg_code;
                }
                if(d.uuid) {
                    document.getElementById('target_uuid').value = d.uuid;
                }
                log(`[Sys] Auto-filled RegCode & UUID`, 'cmd');
            }
        } catch(e){}
    }

    async function bindDevice() {
        await req('/users/bindDeviceByRegCode', 'POST', {
            reg_code: document.getElementById('bind_code').value
        }, true);
    }

    // --- Control Actions ---
    async function sendAction() {
        const uuid = document.getElementById('target_uuid').value;
        if(!uuid) return alert("请先填写目标设备 UUID");

        let params = {};
        try {
            params = JSON.parse(document.getElementById('mqtt_params').value);
        } catch(e) { return alert("Params JSON 格式错误"); }

        await req(`/devices/${uuid}/actions`, 'POST', {
            command: document.getElementById('mqtt_cmd').value,
            params: params
        }, true);
    }

    async function shareDevice() {
        const uuid = document.getElementById('target_uuid').value;
        if(!uuid) return alert("请先填写目标设备 UUID");
        
        // Calculate expires_at (absolute timestamp)
        const seconds = parseInt(document.getElementById('share_exp').value);
        const expiresAt = Math.floor(Date.now() / 1000) + seconds;

        await req(`/devices/${uuid}/share`, 'POST', {
            shared_with_uuid: document.getElementById('share_to_uuid').value,
            permission: document.getElementById('share_perm').value,
            expires_at: expiresAt
        }, true);
    }

    // --- Logging Utils ---
    function log(msg, type) {
        const box = document.getElementById('console_out');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        
        const timestamp = new Date().toLocaleTimeString();
        let content = "";
        
        if (typeof msg === 'object') content = JSON.stringify(msg, null, 2);
        else content = msg;

        if(type === 'err') {
            entry.innerHTML = `<span class="log-err">[${timestamp}] ERR:</span> ${content}`;
        } else if (type === 'cmd') {
             entry.innerHTML = `<span style="color:#bbb">[${timestamp}]</span> <b>${content}</b>`;
        } else {
            entry.innerHTML = `<span class="log-ok">[${timestamp}] OK:</span> ${content}`;
        }
        
        box.insertBefore(entry, box.firstChild);
    }
</script>

</body>
</html>